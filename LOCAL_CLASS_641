*&---------------------------------------------------------------------*
*& Report ZEX_LOCAL_CLASS_641
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zex_local_class_641.

TYPES : BEGIN OF ty_vbak,
          vbeln TYPE vbeln_va,
          erdat TYPE erdat,
          erzet TYPE erzet,
          ernam TYPE ernam,
          vbtyp TYPE vbtypl,
        END OF ty_vbak.

TYPES : BEGIN OF ty_vbap,
          vbeln TYPE vbeln_va,
          posnr TYPE posnr_va,
          matnr TYPE matnr,
        END OF ty_vbap.

TYPES : BEGIN OF ty_final,
          vbeln TYPE vbeln_va,
          erdat TYPE erdat,
          erzet TYPE erzet,
          ernam TYPE ernam,
          vbtyp TYPE vbtypl,
          posnr TYPE posnr_va,
          matnr TYPE matnr,
        END OF ty_final.

DATA: lt_vbak  TYPE TABLE OF ty_vbak,
      ls_vbak  TYPE ty_vbak,
      lt_vbap  TYPE TABLE OF ty_vbap,
      ls_vbap  TYPE ty_vbap,
      lt_final TYPE TABLE OF ty_final,
      ls_final TYPE ty_final.

DATA : lv_vbeln TYPE vbeln_va.

SELECT-OPTIONS : s_vbeln FOR lv_vbeln.

CLASS sales_order DEFINITION.
  PUBLIC SECTION.
    METHODS get_data.
ENDCLASS.


CLASS sales_order IMPLEMENTATION.
  METHOD get_data.
    SELECT vbeln erdat erzet ernam vbtyp
    FROM vbak INTO TABLE lt_vbak
    WHERE vbeln IN s_vbeln.
    IF lt_vbak IS NOT INITIAL.
      SELECT vbeln posnr matnr
      FROM vbap INTO TABLE lt_vbap
      FOR ALL ENTRIES IN lt_vbak
      WHERE vbeln = lt_vbak-vbeln.
    ENDIF.
    LOOP AT lt_vbap INTO ls_vbap.
      ls_final-posnr = ls_vbap-posnr.
      ls_final-matnr = ls_vbap-matnr.
      READ TABLE lt_vbak INTO ls_vbak WITH KEY vbeln = ls_vbap-vbeln.
      IF  sy-subrc EQ 0.
        ls_final-vbeln = ls_vbak-vbeln.
        ls_final-erdat = ls_vbak-erdat.
        ls_final-erzet = ls_vbak-erzet.
        ls_final-ernam = ls_vbak-ernam.
        ls_final-vbtyp = ls_vbak-vbtyp.
      ENDIF.
      APPEND ls_final TO lt_final.
      CLEAR ls_final.
    ENDLOOP.
  ENDMETHOD.
ENDCLASS.

START-OF-SELECTION.
  DATA(lo_object) = NEW sales_order( ).
  lo_object->get_data( ).
  TRY.
      CALL METHOD cl_salv_table=>factory
        EXPORTING
          list_display = if_salv_c_bool_sap=>false
        IMPORTING
          r_salv_table = DATA(lo_disp)
        CHANGING
          t_table      = lt_final.
    CATCH cx_salv_msg.
  ENDTRY.
  lo_disp->display( ).
