*&---------------------------------------------------------------------*
*& Report ZOOPS_ALV_TOOLBAR_EVENT_641
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zoops_alv_toolbar_event_641.

* Structure declaration for SPFLI (example data source)
TYPES: BEGIN OF ty_spfli,
         carrid    TYPE spfli-carrid,
         connid    TYPE spfli-connid,
         countryfr TYPE spfli-countryfr,
         cityfrom  TYPE spfli-cityfrom,
         airpfrom  TYPE spfli-airpfrom,
         countryto TYPE spfli-countryto,
         cityto    TYPE spfli-cityto,
         airpto    TYPE spfli-airpto,
       END OF ty_spfli.

* Work area and internal table for SPFLI
DATA: it_spfli TYPE STANDARD TABLE OF ty_spfli,
      wa_spfli TYPE ty_spfli.
DATA go_alv       TYPE REF TO cl_gui_alv_grid.

* Class declaration for event handler
CLASS lcl_event_handler DEFINITION.
  PUBLIC SECTION.
    METHODS: handle_toolbar
      FOR EVENT toolbar OF cl_gui_alv_grid
      IMPORTING e_object e_interactive,
      handle_user_command
        FOR EVENT user_command OF cl_gui_alv_grid
        IMPORTING e_ucomm.
ENDCLASS.

* Event handler implementation
CLASS lcl_event_handler IMPLEMENTATION.
  METHOD handle_toolbar.
    DATA: ls_button TYPE stb_button.

* Add a custom button to the toolbar
    ls_button-function = 'CUSTOM_REFRESH'.  " Function code for the button
    ls_button-icon = '@42@'.                " Icon (refresh icon)
    ls_button-text = 'Refresh Data'.        " Button text
    ls_button-quickinfo = 'Refresh the ALV Data'.  " Tooltip
    ls_button-butn_type = 0.               " Normal button
    APPEND ls_button TO e_object->mt_toolbar.

* If e_interactive is set, it means we triggered via set_toolbar_interactive
    IF e_interactive = 'X'.
      " Optional: Add logic for interactive triggers
    ENDIF.
  ENDMETHOD.

  METHOD handle_user_command.
* Handle the custom button action
    CASE e_ucomm.
      WHEN 'CUSTOM_REFRESH'.
* Example action: Refresh the data (re-fetch and REFRESH display)
        PERFORM fetch_data.
        CALL METHOD go_alv->refresh_table_display( ).
        MESSAGE 'Data refreshed!' TYPE 'S'.
    ENDCASE.
  ENDMETHOD.
ENDCLASS.

* Data declarations for ALV
DATA: go_container TYPE REF TO cl_gui_custom_container,

      go_handler   TYPE REF TO lcl_event_handler,
      it_fcat      TYPE lvc_t_fcat,
      it_layout    TYPE lvc_s_layo.


* Start of selection
START-OF-SELECTION.
  PERFORM fetch_data.
  CALL SCREEN 100.

* PBO module
MODULE status_0100 OUTPUT.
  SET PF-STATUS 'SPF'.
  SET TITLEBAR 'TITLE'.

  IF go_alv IS INITIAL.
* Create container (assume 'CC_ALV' is the container name ON screen 100)
    CREATE OBJECT go_container
      EXPORTING
        container_name = 'CC_ALV'.

* Create alv grid
    CREATE OBJECT go_alv
      EXPORTING
        i_parent = go_container.

* Create event handler
    CREATE OBJECT go_handler.
    SET HANDLER go_handler->handle_toolbar FOR go_alv.
    SET HANDLER go_handler->handle_user_command FOR go_alv.

* Build field catalog
    PERFORM build_fieldcat.

* Layout settings
    it_layout-grid_title = 'ALV Toolbar Event Example'.

* Display alv
    CALL METHOD go_alv->set_table_for_first_display
      EXPORTING
        is_layout       = it_layout
      CHANGING
        it_outtab       = it_spfli
        it_fieldcatalog = it_fcat.

* Trigger the toolbar event to regenerate and add custom buttons
    CALL METHOD go_alv->set_toolbar_interactive.
  ENDIF.
ENDMODULE.

* PAI module
MODULE user_command_0100 INPUT.
  CASE sy-ucomm.
    WHEN 'BACK' OR 'EXIT' OR 'CANCEL'.
      LEAVE TO SCREEN 0.
  ENDCASE.
ENDMODULE.

*&---------------------------------------------------------------------*
*&      Form  fetch_data
*&---------------------------------------------------------------------*
FORM fetch_data.
* Select data from spfli
  SELECT carrid connid countryfr cityfrom airpfrom countryto cityto airpto
    FROM spfli INTO TABLE it_spfli
    UP TO 20 ROWS.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  build_fieldcat
*&---------------------------------------------------------------------*
FORM build_fieldcat.
  DATA: ls_fcat TYPE lvc_s_fcat.

  ls_fcat-fieldname = 'CARRID'.
  ls_fcat-scrtext_m = 'Carrier ID'.
  ls_fcat-outputlen = 10.
  APPEND ls_fcat TO it_fcat.

  ls_fcat-fieldname = 'CONNID'.
  ls_fcat-scrtext_m = 'Connection ID'.
  ls_fcat-outputlen = 10.
  APPEND ls_fcat TO it_fcat.

  ls_fcat-fieldname = 'COUNTRYFR'.
  ls_fcat-scrtext_m = 'Country From'.
  ls_fcat-outputlen = 15.
  APPEND ls_fcat TO it_fcat.

  ls_fcat-fieldname = 'CITYFROM'.
  ls_fcat-scrtext_m = 'City From'.
  ls_fcat-outputlen = 20.
  APPEND ls_fcat TO it_fcat.

  ls_fcat-fieldname = 'AIRPFROM'.
  ls_fcat-scrtext_m = 'Airport From'.
  ls_fcat-outputlen = 10.
  APPEND ls_fcat TO it_fcat.

  ls_fcat-fieldname = 'COUNTRYTO'.
  ls_fcat-scrtext_m = 'Country To'.
  ls_fcat-outputlen = 15.
  APPEND ls_fcat TO it_fcat.

  ls_fcat-fieldname = 'CITYTO'.
  ls_fcat-scrtext_m = 'City To'.
  ls_fcat-outputlen = 20.
  APPEND ls_fcat TO it_fcat.

  ls_fcat-fieldname = 'AIRPTO'.
  ls_fcat-scrtext_m = 'Airport To'.
  ls_fcat-outputlen = 10.
  APPEND ls_fcat TO it_fcat.
ENDFORM.
