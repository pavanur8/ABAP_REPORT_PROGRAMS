*&---------------------------------------------------------------------*
*& Report ZPRO_PARALLEL_CURSOR_641
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zpro_parallel_cursor_641.

*---------------------------------------------------------------------*
*  TYPES DECLARATION
*---------------------------------------------------------------------*
TYPES: BEGIN OF ty_vbak,
         vbeln TYPE vbak-vbeln,
         erdat TYPE vbak-erdat,
         ernam TYPE vbak-ernam,
       END OF ty_vbak.

TYPES: BEGIN OF ty_vbap,
         vbeln  TYPE vbap-vbeln,
         posnr  TYPE vbap-posnr,
         matnr  TYPE vbap-matnr,
         kwmeng TYPE vbap-kwmeng,
       END OF ty_vbap.

*---------------------------------------------------------------------*
*  INTERNAL TABLES
*---------------------------------------------------------------------*
DATA: lt_vbak TYPE TABLE OF ty_vbak,
      lt_vbap TYPE TABLE OF ty_vbap.

DATA: ls_vbak TYPE ty_vbak,
      ls_vbap TYPE ty_vbap.

*---------------------------------------------------------------------*
*  SELECT DATA
*---------------------------------------------------------------------*
SELECT vbeln,
       erdat,
       ernam
  FROM vbak
  INTO TABLE @lt_vbak
  UP TO 10 ROWS. " Limit for demo

IF sy-subrc <> 0.
  WRITE: / 'No Sales Order data found in VBAK.'.
  EXIT.
ENDIF.

SELECT vbeln,
       posnr,
       matnr,
       kwmeng
  FROM vbap
  INTO TABLE @lt_vbap
  FOR ALL ENTRIES IN @lt_vbak
  WHERE vbeln = @lt_vbak-vbeln.

IF sy-subrc <> 0.
  WRITE: / 'No Item data found in VBAP.'.
  EXIT.
ENDIF.

*---------------------------------------------------------------------*
*  SORT TABLES BEFORE USING PARALLEL CURSOR
*---------------------------------------------------------------------*
SORT lt_vbak BY vbeln.
SORT lt_vbap BY vbeln.

*---------------------------------------------------------------------*
*  MAIN PROCESSING USING PARALLEL CURSOR
*---------------------------------------------------------------------*
DATA: lv_tabix TYPE sy-tabix.

LOOP AT lt_vbak INTO ls_vbak.

  " Binary search to find the first matching item for this sales order
  READ TABLE lt_vbap INTO ls_vbap
       WITH KEY vbeln = ls_vbak-vbeln
       BINARY SEARCH.

  IF sy-subrc = 0.

    " Save current index position
    lv_tabix = sy-tabix.

    " Process all items for this header
    LOOP AT lt_vbap INTO ls_vbap FROM lv_tabix.
      IF ls_vbap-vbeln <> ls_vbak-vbeln.
        EXIT.
      ENDIF.

      " Output both header and item data
      WRITE: / 'Sales Order:', ls_vbak-vbeln,
               'Date:', ls_vbak-erdat,
               'User:', ls_vbak-ernam,
               'Item:', ls_vbap-posnr,
               'Material:', ls_vbap-matnr,
               'Qty:', ls_vbap-kwmeng.
    ENDLOOP.

  ENDIF.
ENDLOOP.

*---------------------------------------------------------------------*
*  END OF PROGRAM
*---------------------------------------------------------------------*
WRITE: / '--- Data Display Complete ---'.




"============================================================================

"Exapmle one for parallel cursor


**TYPES: BEGIN OF ty_header,
**         vbeln TYPE vbeln,
**         kunnr TYPE kunnr,
**       END OF ty_header.
**
**TYPES: BEGIN OF ty_item,
**         vbeln TYPE vbeln,
**         posnr TYPE posnr,
**         matnr TYPE matnr,
**       END OF ty_item.
**
**DATA: it_header TYPE TABLE OF ty_header,
**      it_item   TYPE TABLE OF ty_item,
**      ls_header TYPE ty_header,
**      ls_item   TYPE ty_item.
**
*** Sample data for header
**it_header = VALUE #(
**  ( vbeln = '1001' kunnr = 'CUST01' )
**  ( vbeln = '1002' kunnr = 'CUST02' )
**  ( vbeln = '1003' kunnr = 'CUST03' )
**).
**
*** Sample data for item
**it_item = VALUE #(
**  ( vbeln = '1001' posnr = '10' matnr = 'MAT01' )
**  ( vbeln = '1001' posnr = '20' matnr = 'MAT02' )
**  ( vbeln = '1002' posnr = '10' matnr = 'MAT03' )
**  ( vbeln = '1003' posnr = '10' matnr = 'MAT04' )
**  ( vbeln = '1003' posnr = '20' matnr = 'MAT05' )
**  ( vbeln = '1003' posnr = '30' matnr = 'MAT06' )
**).
**
*** Sort both tables by VBELN
**SORT it_header BY vbeln.
**SORT it_item BY vbeln.
**
**DATA: lv_index TYPE sy-tabix.
**
**LOOP AT it_header INTO ls_header.
**  WRITE: / 'Header:', ls_header-vbeln, ls_header-kunnr.
**
**  LOOP AT it_item INTO ls_item FROM lv_index.
**    IF ls_item-vbeln = ls_header-vbeln.
**      WRITE: / '   Item:', ls_item-posnr, ls_item-matnr.
**    ELSEIF ls_item-vbeln > ls_header-vbeln.
**      EXIT.
**    ENDIF.
**    lv_index = sy-tabix.
**  ENDLOOP.
**ENDLOOP.
